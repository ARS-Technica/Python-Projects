"""
The purpose of this project is to hammer out a new feature for PyRex Basic
that will return an example of any given Regular Expression by using the
rstr library.  

Once this program is running, it will be folded into the larger PyRex Basic
project as a menu option.
"""

from collections import defaultdict
from pathlib import Path 
import rstr
import re
import tkinter as tk
from tkinter import ttk
from trie import Trie
from typing import List, Optional, Union


class RegExpConfig:
    """
    Holds all configuration options for regex generation.
    Mirrors the settings from the Rust version of grex.
    """

    def __init__(
        self,
        use_repetitions: bool = True,
        use_capturing_groups: bool = False,
        verbose: bool = False,
        anchored: bool = True,
        case_insensitive: bool = False,
    ):
        self.use_repetitions = use_repetitions
        self.use_capturing_groups = use_capturing_groups
        self.verbose = verbose
        self.anchored = anchored
        self.case_insensitive = case_insensitive

        # Character conversions
        self.is_digit_converted = False
        self.is_non_digit_converted = False
        self.is_space_converted = False
        self.is_non_space_converted = False
        self.is_word_converted = False
        self.is_non_word_converted = False

        # Pattern optimizations
        self.is_repetition_converted = False
        # Default to 2 so detect_repetition only matches true repetitions (e.g. "abcabc")
        self.minimum_repetitions = 2
        self.minimum_substring_length = 1

        # Matching behavior
        self.is_case_insensitive_matching = False
        self.is_capturing_group_enabled = False
        self.is_verbose_mode_enabled = False

        # Anchors
        self.is_start_anchor_disabled = False
        self.is_end_anchor_disabled = False

        # Escaping
        self.is_non_ascii_char_escaped = False
        self.is_astral_code_point_converted_to_surrogate = False


def auto_generate_sample():
    """
    Automatically generate a sample if the sample input box is empty.

    - Reads the regex pattern from the regex_input text widget.
    - Checks the sample_input text widget.
    - If sample_input is empty and a regex is provided, generates one or more
        sample strings using `generate_samples_from_regex`.
    - Inserts the generated sample(s) into the sample_input widget.
    """
        
    pattern = regex_input.get("1.0", "end-1c").strip()
    sample = sample_input.get("1.0", "end-1c").strip()

    if not sample and pattern:
        generated = generate_sample_from_regex(pattern)
        sample_input.delete("1.0", "end")
        sample_input.insert("1.0", generated)


def generate_sample_from_regex(pattern: str, max_attempts=5) -> str:
    """
    Generate example matching text for the given regex pattern.
    If generation fails, returns an empty string.

    Args:
        pattern (str): The regex pattern to generate a sample from.
        max_attempts (int): Number of attempts to try generating a valid sample.

    Returns:
        str: A string matching the regex pattern.
             Returns "[Invalid regex]" if the pattern is invalid.
             Returns "[Unable to generate sample]" if no valid string could be generated.
    """

    # Quick validation of pattern
    try:
        re.compile(pattern)
    except re.error:
        return "Invalid Regular Expression"

    # Try to generate a match
    for _ in range(max_attempts):
        try:
            sample = rstr.xeger(pattern)
            if sample:  # Ensure it's not empty
                return sample
        except Exception:
            pass

    return "Unable to generate sample"


def create_window():
    global generate_button, regex_input, sample_input

    # Tkinter GUI setup
    root = tk.Tk()
    root.title("Regex Sample Generator")

    # Regex input field
    ttk.Label(root, text="Enter Regex Pattern:").grid(row=0, column=0, sticky="w", padx=5, pady=(5, 2))
    regex_input = tk.Text(root, height=2, width=50)
    regex_input.grid(row=1, column=0, padx=5, pady=2, sticky="ew")

    # Sample output field
    ttk.Label(root, text="Sample Output:").grid(row=2, column=0, sticky="w", padx=5, pady=(5, 2))
    sample_input = tk.Text(root, height=5, width=50)
    sample_input.grid(row=3, column=0, padx=5, pady=2, sticky="ew")

    # Button to generate
    generate_button = ttk.Button(root, text="Generate Sample", command=auto_generate_sample)
    generate_button.grid(row=4, column=0, padx=5, pady=10, sticky="ew")

    # Expand window with resizing
    root.columnconfigure(0, weight=1)

    root.mainloop()


if __name__ == "__main__":
    # Run the application
    create_window()



